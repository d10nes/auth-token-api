const express = require('express');
const cors = require('cors');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');

const app = express();
const PORT = process.env.PORT || 3000;
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';

// Middleware
app.use(cors());
app.use(express.json());

// ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ° Ğ±Ñ‹ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
const user = {
  id: 1,
  username: 'nugyman',
  // Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ 'nugyman01'
  passwordHash: bcrypt.hashSync('nugyman01', 10),
  email: 'nugmanesenalin@gmail.com',
  firstName: 'Nugyman',
  lastName: 'Esenalin',
  gender: 'male',
  image: 'https://ui-avatars.com/api/?name=Nugyman+Esenalin&size=128'
};

// Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ refresh Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ - Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
const refreshTokens = new Set();

// Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
function generateTokens(userId) {
  const accessToken = jwt.sign(
    { userId, type: 'access' },
    JWT_SECRET,
    { expiresIn: '60m' } // 60 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  );
  
  const refreshToken = jwt.sign(
    { userId, type: 'refresh' },
    JWT_SECRET,
    { expiresIn: '7d' } // 7 Ğ´Ğ½ĞµĞ¹
  );
  
  return { accessToken, refreshToken };
}

// Middleware Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ access token
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({ message: 'Access token Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' });
  }

  jwt.verify(token, JWT_SECRET, (err, decoded) => {
    if (err) {
      return res.status(401).json({ message: 'Access token Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½' });
    }
    
    if (decoded.type !== 'access') {
      return res.status(401).json({ message: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ñ‚Ğ¾ĞºĞµĞ½Ğ°' });
    }
    
    req.userId = decoded.userId;
    next();
  });
}

// ============================================
// ENDPOINTS
// ============================================

// POST /auth/login - Ğ’Ñ…Ğ¾Ğ´
app.post('/auth/login', async (req, res) => {
  try {
    const { username, password, expiresInMins = 60 } = req.body;

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºÑ€ĞµĞ´ĞµĞ½ÑˆĞ°Ğ»Ğ¾Ğ²
    if (username !== user.username) {
      return res.status(401).json({ message: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ' });
    }

    const isPasswordValid = await bcrypt.compare(password, user.passwordHash);
    if (!isPasswordValid) {
      return res.status(401).json({ message: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ' });
    }

    // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
    const { accessToken, refreshToken } = generateTokens(user.id);
    refreshTokens.add(refreshToken);

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ + Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
    res.json({
      id: user.id,
      username: user.username,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      gender: user.gender,
      image: user.image,
      accessToken,
      refreshToken
    });
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ message: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
  }
});

// POST /auth/refresh - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
app.post('/auth/refresh', (req, res) => {
  try {
    const { refreshToken } = req.body;

    if (!refreshToken) {
      return res.status(401).json({ message: 'Refresh token Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' });
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ
    if (!refreshTokens.has(refreshToken)) {
      return res.status(403).json({ message: 'Refresh token Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½' });
    }

    // Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
    jwt.verify(refreshToken, JWT_SECRET, (err, decoded) => {
      if (err) {
        refreshTokens.delete(refreshToken); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
        return res.status(403).json({ message: 'Refresh token Ğ¸ÑÑ‚Ñ‘Ğº' });
      }

      if (decoded.type !== 'refresh') {
        return res.status(403).json({ message: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ñ‚Ğ¾ĞºĞµĞ½Ğ°' });
      }

      // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ refresh token
      refreshTokens.delete(refreshToken);

      // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
      const tokens = generateTokens(decoded.userId);
      refreshTokens.add(tokens.refreshToken);

      res.json(tokens);
    });
  } catch (error) {
    console.error('Refresh error:', error);
    res.status(500).json({ message: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
  }
});

// GET /auth/me - ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ (Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹)
app.get('/auth/me', authenticateToken, (req, res) => {
  try {
    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ)
    res.json({
      id: user.id,
      username: user.username,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      gender: user.gender,
      image: user.image
    });
  } catch (error) {
    console.error('Get profile error:', error);
    res.status(500).json({ message: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
  }
});

// GET /profile - ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¹Ğ½Ñ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ (Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
app.get('/profile', authenticateToken, (req, res) => {
  try {
    res.json({
      id: user.id,
      username: user.username,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      gender: user.gender,
      image: user.image
    });
  } catch (error) {
    console.error('Get profile error:', error);
    res.status(500).json({ message: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
  }
});

// POST /auth/logout - Ğ’Ñ‹Ñ…Ğ¾Ğ´ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
app.post('/auth/logout', (req, res) => {
  try {
    const { refreshToken } = req.body;
    
    if (refreshToken) {
      refreshTokens.delete(refreshToken);
    }
    
    res.json({ message: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾' });
  } catch (error) {
    console.error('Logout error:', error);
    res.status(500).json({ message: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'OK', message: 'Auth API is running' });
});

// ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.json({
    message: 'Auth Token API',
    version: '1.0.0',
    endpoints: {
      login: 'POST /auth/login',
      refresh: 'POST /auth/refresh',
      profile: 'GET /auth/me',
      logout: 'POST /auth/logout',
      health: 'GET /health'
    },
    credentials: {
      username: 'nugyman',
      password: 'nugyman01'
    }
  });
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, () => {
  console.log(`ğŸš€ Auth API server running on port ${PORT}`);
  console.log(`ğŸ“ Test credentials: nugyman / nugyman01`);
});
